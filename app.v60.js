(function(){var IDB_KEY='tasks';var state={tasks:[],currentId:null};var els={list:document.getElementById('taskList'),newTaskTitle:document.getElementById('newTaskTitle'),addTaskBtn:document.getElementById('addTaskBtn'),viewList:document.getElementById('view-list'),viewDetail:document.getElementById('view-detail'),backBtn:document.getElementById('backBtn'),taskTitle:document.getElementById('taskTitle'),newSubtaskTitle:document.getElementById('newSubtaskTitle'),addSubtaskBtn:document.getElementById('addSubtaskBtn'),checklist:document.getElementById('checklist')};function uid(){return'id_'+Math.random().toString(36).slice(2,10)}function splitFolderTitle(s){s=(s||'').trim();var seps=['::','/','>'];for(var i=0;i<seps.length;i++){var idx=s.indexOf(seps[i]);if(idx>0)return{folder:s.slice(0,idx).trim(),title:s.slice(idx+seps[i].length).trim()}}return{folder:null,title:s}}function refreshDone(t){t.done=t.items.length>0&&t.items.every(it=>it.done)}function save(){return mintIDB.setJSON(IDB_KEY,state.tasks)}function load(){return mintIDB.getJSON(IDB_KEY,[])}function renderTasks(){els.list.innerHTML='';state.tasks.forEach(t=>{var c=document.createElement('div');c.className='card';c.textContent=t.title+(t.done?' âœ…':'');c.onclick=()=>{state.currentId=t.id;route('detail')};els.list.appendChild(c)})}function renderChecklist(t){els.checklist.innerHTML='';var groups={};t.items.forEach(it=>{var p=splitFolderTitle(it.title);var key=p.folder||'__NO';if(!groups[key])groups[key]=[];groups[key].push({id:it.id,title:p.title,done:it.done,folder:p.folder})});Object.keys(groups).sort().forEach(k=>{if(k!=='__NO'){var h=document.createElement('div');h.className='checklist-folder';h.textContent=k;els.checklist.appendChild(h)}groups[k].forEach(it=>{var row=document.createElement('div');var cb=document.createElement('input');cb.type='checkbox';cb.checked=it.done;cb.onchange=()=>{var orig=t.items.find(x=>x.id===it.id);if(orig)orig.done=cb.checked;refreshDone(t);save().then(()=>{renderTasks();renderChecklist(t)})};row.appendChild(cb);row.appendChild(document.createTextNode(it.title));els.checklist.appendChild(row)})})}function route(w){if(w==='detail'){els.viewList.classList.add('hidden');els.viewDetail.classList.remove('hidden');var t=state.tasks.find(x=>x.id===state.currentId);if(t){els.taskTitle.textContent=t.title;renderChecklist(t)}}else{els.viewDetail.classList.add('hidden');els.viewList.classList.remove('hidden');renderTasks()}}els.addTaskBtn.onclick=()=>{var s=els.newTaskTitle.value.trim();if(!s)return;state.tasks.push({id:uid(),title:s,done:false,items:[]});els.newTaskTitle.value='';save().then(renderTasks)};els.backBtn.onclick=()=>route('list');els.addSubtaskBtn.onclick=()=>{var t=state.tasks.find(x=>x.id===state.currentId);if(!t)return;var s=els.newSubtaskTitle.value.trim();if(!s)return;t.items.push({id:uid(),title:s,done:false});els.newSubtaskTitle.value='';refreshDone(t);save().then(()=>renderChecklist(t))};load().then(ts=>{state.tasks=ts;renderTasks()})})()